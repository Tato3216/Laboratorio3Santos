{% extends "base.html" %}
{% block content %}
<h1 class="h3">{{ 'Editar' if quote else 'Nueva' }} cotización</h1>

<form method="post" class="mt-3">
  <!-- Datos de la cotización -->
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <select name="client_id" class="form-select" required>
        <option value="">— Seleccionar —</option>
        {% for c in clients %}
          {% set selected_id = (quote.client_id if quote else (default_client_id or None)) %}
          <option value="{{ c.id }}" {% if selected_id==c.id %}selected{% endif %}>
            {{ c.full_name() }} — {{ c.email }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Estado</label>
      {% set current_status = quote.status if quote else 'borrador' %}
      <select name="status" class="form-select">
        {% for s in ['borrador','enviada','aceptada','rechazada','vencida'] %}
          <option value="{{ s }}" {% if current_status==s %}selected{% endif %}>{{ s|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Válida hasta</label>
      <input name="valid_until" type="date" class="form-control"
             value="{{ quote.valid_until.isoformat() if quote and quote.valid_until }}">
    </div>

    <div class="col-12">
      <label class="form-label">Notas</label>
      <textarea name="notes" rows="3" class="form-control">{{ quote.notes if quote else '' }}</textarea>
    </div>
  </div>

  <!-- Ítems -->
  <div class="card mt-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span>Ítems de la cotización</span>
      <button type="button" id="btn-add" class="btn btn-sm btn-outline-secondary">Agregar ítem</button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-sm align-middle mb-0">
        <thead>
        <tr>
          <th style="width:24%">Producto</th>
          <th>Descripción</th>
          <th style="width:10%">Cant.</th>
          <th style="width:14%">P. Unitario (Q)</th>
          <th style="width:12%" class="text-end">Importe (Q)</th>
          <th style="width:6%"></th>
        </tr>
        </thead>
        <tbody id="items-body">
        <!-- Fila plantilla (oculta) -->
        <tr class="item-row d-none" id="row-template">
          <td>
            <select class="form-select item-product">
              <option value="">— Seleccionar —</option>
            </select>
            <input type="hidden" name="item_product_id[]">
          </td>
          <td><input name="item_description[]" class="form-control" placeholder="Descripción del ítem"></td>
          <td><input name="item_qty[]" type="number" step="0.01" min="0" class="form-control" value="1" inputmode="decimal"></td>
          <td><input name="item_price[]" type="number" step="0.01" min="0" class="form-control" value="0" inputmode="decimal"></td>
          <td class="item-amount text-end">0.00</td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar">✕</button>
          </td>
        </tr>

        {% if quote and quote.items %}
          {% for it in quote.items %}
            <tr class="item-row">
              <td>
                <select class="form-select item-product" data-selected="{{ it.product_id or '' }}">
                  <option value="">— Seleccionar —</option>
                </select>
                <input type="hidden" name="item_product_id[]" value="{{ it.product_id or '' }}">
              </td>
              <td><input name="item_description[]" class="form-control" value="{{ it.description }}"></td>
              <td><input name="item_qty[]" type="number" step="0.01" min="0" class="form-control" value="{{ '%.2f'|format(it.quantity) }}" inputmode="decimal"></td>
              <td><input name="item_price[]" type="number" step="0.01" min="0" class="form-control" value="{{ '%.2f'|format(it.unit_price) }}" inputmode="decimal"></td>
              <td class="item-amount text-end">0.00</td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar">✕</button>
              </td>
            </tr>
          {% endfor %}
        {% endif %}
        </tbody>
        <tfoot>
        <tr>
          <th colspan="4" class="text-end">TOTAL (Q)</th>
          <th class="text-end" id="grand-total">0.00</th>
          <th></th>
        </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Guardar</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('quotes.list_quotes') }}">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let PRODUCTS = [];

// Cargar catálogo para autocompletar
fetch("{{ url_for('products.api_products') }}")
  .then(r => r.json())
  .then(data => {
    PRODUCTS = data || [];
    // Poblar selects existentes (modo edición)
    document.querySelectorAll('.item-product').forEach(sel => fillSelect(sel, sel.getAttribute('data-selected')));
    recalcAll();
  });

function fillSelect(selectEl, selectedId) {
  const current = selectedId ? parseInt(selectedId) : null;
  const valueBefore = selectEl.value;
  selectEl.innerHTML = '<option value="">— Seleccionar —</option>';
  PRODUCTS.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = (p.sku ? p.sku + " — " : "") + p.name + " (Q " + Number(p.price).toFixed(2) + ")";
    if (current && p.id === current) opt.selected = true;
    selectEl.appendChild(opt);
  });
  if (!current && valueBefore) selectEl.value = valueBefore;
}

function addRow(prefill) {
  const tpl = document.getElementById('row-template');
  const row = tpl.cloneNode(true);
  row.id = "";
  row.classList.remove('d-none');
  document.getElementById('items-body').appendChild(row);

  const sel = row.querySelector('.item-product');
  const hid = row.querySelector('input[name="item_product_id[]"]');
  const desc = row.querySelector('input[name="item_description[]"]');
  const qty  = row.querySelector('input[name="item_qty[]"]');
  const prc  = row.querySelector('input[name="item_price[]"]');

  fillSelect(sel, prefill && prefill.product_id ? prefill.product_id : null);

  if (prefill) {
    if (prefill.product_id) { sel.value = prefill.product_id; hid.value = prefill.product_id; }
    if (prefill.description) desc.value = prefill.description;
    if (prefill.qty != null) qty.value = prefill.qty;
    if (prefill.price != null) prc.value = prefill.price;
  }

  sel.addEventListener('change', () => {
    const id = parseInt(sel.value || 0);
    hid.value = id || "";
    if (id) {
      const p = PRODUCTS.find(x => x.id === id);
      if (p) {
        if (!desc.value) desc.value = p.name;
        prc.value = Number(p.price).toFixed(2);
        recalcRow(row); recalcAll();
      }
    }
  });

  [qty, prc].forEach(inp => inp.addEventListener('input', () => { recalcRow(row); recalcAll(); }));
  row.querySelector('.btn-del').addEventListener('click', () => { row.remove(); recalcAll(); });

  recalcRow(row); recalcAll();
}

function recalcRow(tr) {
  const q = parseFloat(tr.querySelector('input[name="item_qty[]"]').value || 0);
  const pu = parseFloat(tr.querySelector('input[name="item_price[]"]').value || 0);
  tr.querySelector('.item-amount').textContent = (q * pu).toFixed(2);
}

function recalcAll() {
  let total = 0;
  document.querySelectorAll('#items-body .item-row').forEach(tr => {
    if (tr.id === 'row-template') return;
    const q = parseFloat(tr.querySelector('input[name="item_qty[]"]').value || 0);
    const pu = parseFloat(tr.querySelector('input[name="item_price[]"]').value || 0);
    total += q * pu;
  });
  document.getElementById('grand-total').textContent = total.toFixed(2);
}

// Botón agregar
document.getElementById('btn-add').addEventListener('click', () => addRow());

// Si es creación y no hay filas, agregamos una por defecto
document.addEventListener('DOMContentLoaded', () => {
  const hasRows = document.querySelectorAll('#items-body .item-row:not(#row-template)').length > 0;
  if (!hasRows) addRow();
});
</script>
{% endblock %}